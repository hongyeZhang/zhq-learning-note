
# 《亿级流量网络架构核心技术》




### consul 注册中心

Consul 本身使用 go 语言开发，具有跨平台、运行高效等特点，也非常方便和 Docker 配合使用。


## chapter4  限流详解
### 限流
* 分布式限流 redis + lua : 实现业务上的限流，而不是入口流量的限流
* nginx 接入层限流

## chapter5 降级
保证核心服务可用
* 自动开关降级
  * 超时降级
  * 统计失败次数降级
  * 故障降级
  * 限流降级
* 人工开关降级 ： 开关放到配置文件、数据库、redis、zookeeper
  * 使用配置中心存放开关，实现不重启应用即可动态配置开关
  * JVM WatchService 可以检测文件的变化，启动一个守护线程进行监听即可
* 读服务降级： 静态化 --> 动态化
* 多级降级：页面JS降级开关 -> 接入层降级开关 -> 应用层降级开关

## chapter6 超时与重试机制
重要的超时设置：网络连接、读、写
* 代理层超时与重试
* web容器超时
* 中间件客户端超时与重试
* 数据库（NoSQL）客户端超时
* 业务超时
* 前端ajax超时

对于非幂等的接口，要避免重试

## chapter7 回滚机制
无

## chapter8 压测与预案
无

## chapter9 应用级缓存
* 缓存命中率
* 缓存回收策略
  * 空间
  * 时间
  * 引用
  * 回收算法：LRU(应用最多) FIFO LFU

### java缓存类型
* 堆内缓存 Guava Cache
* 堆外缓存
* 磁盘缓存
* 分布式缓存

堆内缓存 -> 堆外缓存 -> 分布式缓存
 Ehcache
 Java开源缓存平台Terracotta

### 一致性哈希
一致性哈希的空间是一个圆环，节点分布是基于圆环的

当增加或者删除节点时，对于大多数记录，保证原来分配到的某个节点，现在仍然应该分配到那个节点，将数据迁移量的降到最低，这就是一致性哈希要做的事情。
在这里我们不指定是数据库还是什么，反正都是分布式存储节点。

一致性哈希主要就是解决当机器减少或增加的时候，大面积的数据重新哈希的问题，主要从下面 2 个方向去考虑的，
当节点宕机时，数据记录会被定位到下一个节点上，当新增节点的时候 ，相关区间内的数据记录就需要重新哈希。

一致性Hash算法在服务节点太少时，容易因为节点分部不均匀而造成数据倾斜
为了避免出现数据倾斜问题，一致性 Hash 算法引入了虚拟节点的机制，也就是每个机器节点会进行多次哈希，最终每个机器节点在哈希环上会有多个虚拟节点存在，使用这种方式来大大削弱甚至避免数据倾斜问题。


## chapter10 HTTP缓存
* 浏览器缓存
* HttpClient













