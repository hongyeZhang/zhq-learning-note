

# Sentinel 学习笔记

## reference
* http://www.iocoder.cn/Spring-Boot/Sentinel/?self
    * 完整代码示例，可见 https://github.com/YunaiV/SpringBoot-Labs 的 lab-46 目录。


## 基本知识
* 流量控制有以下几个角度:
    * 资源的调用关系，例如资源的调用链路，资源和资源之间的关系；
    * 运行指标，例如 QPS、线程池、系统负载等；
    * 控制的效果，例如直接限流、冷启动、排队等。
* 主要功能
    * 流量控制
    * 熔断降级
    * 热点参数限流
    * 系统自适应限流（根据机器的性能指标进行限流）
    * 黑白名单控制
    * 没有框架支持时，使用API进行接入
    * 基于分布式配置中心，进行规则管理及推送 （nacos  apollo 本地file redis zookeeper etcd consul）
        * 原始模式
        * 推模式
        * 拉模式

* 与hystrix的相同与不同
    * Sentinel 和 Hystrix 的原则是一致的: 当检测到调用链路中某个资源出现不稳定的表现，例如请求响应时间长或异常比例升高的时候，则对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联故障
    * Hystrix 通过 线程池隔离 的方式，来对依赖（在 Sentinel 的概念中对应 资源）进行了隔离。这样做的好处是资源和资源之间做到了最彻底的隔离。缺点是除了增加了线程切换的成本（过多的线程池导致线程数目过多），
        还需要预先给各个资源做线程池大小的分配。
* Sentinel 线程切换的消耗问题的改进：
    * 1、通过并发线程数进行限制。
        * 和资源池隔离的方法不同，Sentinel 通过限制资源并发线程的数量，来减少不稳定资源对其它资源的影响。这样不但没有线程切换的损耗，也不需要您预先分配线程池的大小。当某个资源出现不稳定的情况下，例如响应时间变长，
          对资源的直接影响就是会造成线程数的逐步堆积。当线程数在特定资源上堆积到一定的数量之后，对该资源的新请求就会被拒绝。堆积的线程完成任务后才开始继续接收请求。
    * 2、通过响应时间对资源进行降级
         * 除了对并发线程数进行控制以外，Sentinel 还可以通过响应时间来快速降级不稳定的资源。当依赖的资源出现响应时间过长后，所有对该资源的访问都会被直接拒绝，直到过了指定的时间窗口之后才重新恢复

* 流量控制的指标
    * 平均响应时间 (DEGRADE_GRADE_RT)
    * 异常比例 (DEGRADE_GRADE_EXCEPTION_RATIO)
    * 异常数 (DEGRADE_GRADE_EXCEPTION_COUNT)


## 实战
* 启动控制台  dashboard

```shell script
java -jar --server.port=7070

```
* 单机限流
* 分布式限流


